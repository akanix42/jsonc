{"version":3,"sources":["deserializer.es6"],"names":[],"mappings":"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","file":"deserializer.js","sourcesContent":["'use strict';\r\nimport _ from 'lodash';\r\nimport autobind from 'autobind-decorator'\r\n\r\nexport default class Deserializer {\r\n  static Symbols = {PostProcess: Symbol()};\r\n\r\n  data = null;\r\n  instances = null;\r\n  objectsToPostProcess = [];\r\n\r\n  constructor(jsonc) {\r\n    this.jsonc = jsonc;\r\n  }\r\n\r\n  deserialize(data) {\r\n    this.data = data;\r\n    this.instances = this._map(this.data.instances, this._instantiateValue);\r\n\r\n    _.forEach(this.instances, this._restoreProperties);\r\n    this._restoreProperties(this.data.root);\r\n    _.forEach(this.objectsToPostProcess, this._postProcess);\r\n\r\n    return this.data.root;\r\n  }\r\n\r\n  @autobind\r\n  _map(obj, fn) {\r\n    if (obj instanceof Array)\r\n      return _.map(obj, fn, this);\r\n    else\r\n      return _.mapValues(obj, fn, this);\r\n  }\r\n\r\n  @autobind\r\n  _instantiateValue(value) {\r\n    const isRegisteredType = (obj) => '__type__' in obj && obj.__type__ && this.jsonc.hasTypeName(obj.__type__);\r\n    const isNativeType = (obj) => '__type__' in obj && (obj.__type__ === '__object__' || obj.__type__ === '__array__');\r\n\r\n    const typeCategory = this._getTypeCategory(value);\r\n    if (typeCategory === 'function')\r\n      return undefined;\r\n\r\n    if (typeCategory === 'primitive')\r\n      return value;\r\n\r\n    if (isRegisteredType(value))\r\n      return instantiateRegisteredType.call(this, value);\r\n\r\n    if (isNativeType(value))\r\n      return instantiateNativeType.call(this, value);\r\n\r\n    return value;\r\n\r\n\r\n    function instantiateRegisteredType(obj) {\r\n      var instance = new this.jsonc.registry[obj.__type__].type();\r\n      if (instance[Deserializer.Symbols.PostProcess])\r\n        this.objectsToPostProcess.push(instance);\r\n      return _.assign(instance, obj.__value__);\r\n    }\r\n\r\n    function instantiateNativeType(obj) {\r\n      var instance = obj.__type__ === '__object__'\r\n        ? {}\r\n        : [];\r\n      return _.assign(instance, obj.__value__);\r\n    }\r\n  }\r\n\r\n  @autobind\r\n  _getTypeCategory(value) {\r\n    const type = typeof value;\r\n    if (type === 'function' || (value !== null && type === 'object'))\r\n      return type;\r\n    return 'primitive';\r\n  }\r\n\r\n  @autobind\r\n  _restoreProperties(obj) {\r\n    const typeCategory = this._getTypeCategory(obj);\r\n    if (typeCategory !== 'object')\r\n      return;\r\n\r\n    _.forOwn(obj, this._restoreProperty);\r\n  }\r\n\r\n  @autobind\r\n  _restoreProperty(value, key, obj) {\r\n    const isReference = (obj) => '__index__' in obj;\r\n    const typeCategory = this._getTypeCategory(value);\r\n    if (typeCategory !== 'object')\r\n      return;\r\n\r\n    if (isReference(value))\r\n      obj[key] = this.instances[value.__index__];\r\n  }\r\n\r\n  @autobind\r\n  _postProcess(obj) {\r\n    obj[Deserializer.Symbols.PostProcess]();\r\n  }\r\n}\r\n"]}