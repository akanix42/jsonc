{"version":3,"sources":["serializer.es6"],"names":[],"mappings":"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","file":"serializer.js","sourcesContent":["\"use strict\";\r\nimport _ from 'lodash';\r\nimport autobind from 'autobind-decorator'\r\n\r\nexport default class Serializer {\r\n  static Symbols = {Serialize: Symbol()};\r\n\r\n  _instancesMap = new Map();\r\n  _instances = [];\r\n\r\n  constructor(jsonc) {\r\n    this.jsonc = jsonc;\r\n  }\r\n\r\n  serialize(data) {\r\n    this.data = data;\r\n    return {\r\n      instances: this._instances,\r\n      root: this._map(this.data)\r\n    };\r\n  }\r\n\r\n  convertRegisteredTypeToDto(obj) {\r\n    var reference = this._getInstance(obj);\r\n    if (reference)\r\n      return reference;\r\n\r\n    var instance = {\r\n      __type__: obj.constructor.__type__\r\n    };\r\n\r\n    reference = this._addInstance(obj, instance);\r\n\r\n    const data = Serializer.Symbols.Serialize in obj\r\n      ? obj[Serializer.Symbols.Serialize]()\r\n      : obj;\r\n\r\n    const registration = this.jsonc.registry[instance.__type__];\r\n    instance.__value__ = this._map(data, registration.options);\r\n\r\n    return reference;\r\n  }\r\n\r\n  convertPlainObjectToDto(obj) {\r\n    var reference = this._getInstance(obj);\r\n    if (reference)\r\n      return reference;\r\n\r\n    var instance = {\r\n      __type__: \"__object__\"\r\n    };\r\n    reference = this._addInstance(obj, instance);\r\n\r\n    const data = Serializer.Symbols.Serialize in obj\r\n      ? obj[Serializer.Symbols.Serialize]()\r\n      : obj;\r\n\r\n    instance.__value__ = this._map(data);\r\n\r\n    return reference;\r\n  }\r\n\r\n  convertNativeTypeToDto(obj) {\r\n    var reference = this._getInstance(obj);\r\n    if (reference)\r\n      return reference;\r\n\r\n    var instance = {\r\n      __type__: \"__array__\"\r\n    };\r\n    reference = this._addInstance(obj, instance);\r\n\r\n    instance.__value__ = this._map(obj);\r\n\r\n    return reference;\r\n  }\r\n\r\n  isSerializableObject(obj) {\r\n    if (obj === null || obj === undefined)\r\n      return false;\r\n\r\n    var constructor = obj.constructor;\r\n    return (this.jsonc.hasType(constructor))\r\n      || constructor === Object\r\n      || constructor === Array;\r\n  }\r\n\r\n  @autobind\r\n  _addInstance(originalObject, instance) {\r\n    if (this._instancesMap.get(originalObject))\r\n      return;\r\n    var reference = {__index__: this._instances.length};\r\n    this._instances.push(instance);\r\n    this._instancesMap.set(originalObject, reference);\r\n    return reference;\r\n  }\r\n\r\n  @autobind\r\n  _map(obj, options) {\r\n    if (obj instanceof Array)\r\n      return _.map(obj, this._mapValue);\r\n    else {\r\n      if (options) {\r\n        if (options.exclude)\r\n          obj = _.omit(obj, options.exclude);\r\n        if (options.include)\r\n          obj = _.pick(obj, options.include);\r\n      }\r\n      return _.mapValues(obj, this._mapValue);\r\n    }\r\n  }\r\n\r\n  @autobind\r\n  _mapValue(value) {\r\n    var typeCategory = getTypeCategory(value);\r\n    if (typeCategory === \"primitive\")\r\n      return value;\r\n    if (typeCategory === \"object\")\r\n      return this._mapObject(value);\r\n\r\n    function getTypeCategory(value) {\r\n      var type = typeof value;\r\n      if (type === \"function\" || (value !== null && type === \"object\"))\r\n        return type;\r\n      return \"primitive\";\r\n    }\r\n  }\r\n\r\n  @autobind\r\n  _mapObject(obj) {\r\n    if (!this.isSerializableObject(obj)) {\r\n      console.warn(`Object ${JSON.stringify(obj)} of constructor ${obj.constructor.toString()} is not a serializable object and will NOT be recorded!`);\r\n      return null;\r\n    }\r\n\r\n    if (obj.constructor.__type__)\r\n      return this.convertRegisteredTypeToDto(obj);\r\n\r\n    if (obj.constructor === Object)\r\n      return this.convertPlainObjectToDto(obj);\r\n\r\n    return this.convertNativeTypeToDto(obj);\r\n  }\r\n\r\n  @autobind\r\n  _getInstance(instance) {\r\n    return this._instancesMap.get(instance);\r\n  }\r\n}\r\n"]}